# ðŸ§  PERMANENT AGENT BEHAVIORAL RULES

## 1. The "Think Before You Code" Protocol
Before starting any coding task, you must follow this sequence:
1.  **Read:** Review `1-core.md` for context.
2.  **Brainstorm (Scratchpad):** If the task is complex, use `3-scratchpad.md` to draft your algorithm, data structures, or logic flow. "Think out loud" there first.
3.  **Plan (Iteration):** Write the final, clean step-by-step plan in `2-iteration.md`.
4.  **Critique:** Review your plan in `2-iteration.md`. Ask: "Is this efficient? Are there edge cases?" Refine if necessary.

## 2. Strict Test-Driven Development (TDD) Loop
You are prohibited from writing production code without a failing test.
1.  **Red:** Write the specific unit test. **STOP GENERATION.** Ask user to run test to confirm failure.
2.  **Green:** Write the *minimum* code to pass the test. Run test to verify.
3.  **Refactor:** Check code for clarity and maintainability.

## 3. Coding Standards (Python)
- **Language:** Python 3.11+
- **Clarity > Brevity:** Code must be debuggable and explainable. No cryptic one-liners.
- **Dependencies:** Prefer standard libraries or robust, well-known 3rd party packages. Do not reinvent the wheel.
- **Type Hints:** Use type hints for function signatures.
- **Docstrings:** Every public function must have a docstring explaining purpose, args, and return value.

## 4. Documentation Hygiene
- `1-core.md`: Update only upon Feature Completion.
- `2-iteration.md`: Update CONSTANTLY as you check off steps.
- `3-scratchpad.md`: Clear this file after a feature is complete to keep context fresh for the next problem.

## 4b. Git Commit Discipline ðŸ”´ CRITICAL
**Commit frequently to create rollback points and track progress.**

### When to Commit:
1. **After TDD GREEN phase:** When tests pass for a new feature/module
2. **After REFACTOR phase:** When code is cleaned up (separate commit from feature)
3. **After bug fixes:** Each fix gets its own commit
4. **After documentation updates:** Keep docs in sync with code

### Commit Message Format (Conventional Commits):
```
<type>(<scope>): <short description>

Types: feat, fix, refactor, docs, test, chore
Scope: module name (config, parser, exporter, api_client, scraper)
```

### Examples:
- `feat(config): add ScraperConfig with validation`
- `feat(parser): add ListingParser with JSON extraction`
- `fix(exporter): handle empty listings gracefully`
- `refactor(api_client): extract URL building to method`
- `docs: update 1-core.md with Phase 2 completion`
- `test(parser): add edge case tests for missing fields`

### Workflow Integration:
```
TDD Loop:
  RED â†’ GREEN â†’ REFACTOR â†’ COMMIT â†’ next test
                              â†‘
                         Don't skip this!
```

### Tagging Milestones:
After completing a major phase, create a tag:
```bash
git tag -a v0.1.0 -m "Phase 1: Config + Models complete"
git tag -a v0.2.0 -m "Phase 2: Exporter complete"
```

## 5. Project-Specific Rules (Yad2 Scraper)
- **Target Site:** yad2.co.il (Hebrew, RTL)
- **Primary Method:** API requests to `gw.yad2.co.il/recommendations/items/realestate`
- **Fallback:** Playwright browser automation (if API is blocked)
- **Data Format:** Output ONLY Parquet files (no JSON)
- **Encoding:** Handle Hebrew text properly (UTF-8)
- **Rate Limiting:** Be respectful to the target server (add delays between requests)

## 6. Key Dependencies
```
requests            # HTTP client (primary)
playwright          # Browser automation (fallback)
pandas              # Data manipulation  
pyarrow             # Parquet file support
pytest              # Testing framework
pytest-cov          # Test coverage
responses           # Mock HTTP requests in tests
```

## 7. Project Structure (Target)
```
house_data_scrapper/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py           # Configuration management
â”‚   â”œâ”€â”€ models.py           # Listing dataclass
â”‚   â”œâ”€â”€ api_client.py       # HTTP client for Yad2 API
â”‚   â”œâ”€â”€ parser.py           # JSON parsing & data extraction
â”‚   â”œâ”€â”€ exporter.py         # Parquet export functionality
â”‚   â”œâ”€â”€ scraper.py          # Main orchestration logic
â”‚   â””â”€â”€ browser.py          # Playwright browser (fallback)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_config.py
â”‚   â”œâ”€â”€ test_api_client.py
â”‚   â”œâ”€â”€ test_parser.py
â”‚   â”œâ”€â”€ test_exporter.py
â”‚   â””â”€â”€ test_scraper.py
â”œâ”€â”€ data/
â”‚   â””â”€â”€ output/             # Parquet files go here
â”œâ”€â”€ 1-core.md
â”œâ”€â”€ 2-iteration.md
â”œâ”€â”€ 3-scratchpad.md
â”œâ”€â”€ .cursorrules
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

