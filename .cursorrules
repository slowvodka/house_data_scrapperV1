# ðŸ§  PERMANENT AGENT BEHAVIORAL RULES

## 1. The 3-File Context Cycle (MANDATORY)

ðŸ›‘ **Every response must start with a Context Check:**

> **Context Check:**
> 1. [ ] **Brainstorm:** Have I updated `3-scratchpad.md` with my analysis?
> 2. [ ] **Plan:** Is `2-iteration.md` up to date with the next steps?
>
> *If "No" to either, perform updates before writing code.*

### The Cycle (No Exceptions)

```
New Task â†’ Brainstorm â†’ Plan â†’ Execute â†’ Update Docs â†’ Clear Scratchpad
              â†“           â†“        â†“
         3-scratchpad  2-iteration  Code + Tests
```

**Step 1: BRAINSTORM (File: `3-scratchpad.md`)**
- **WHEN:** BEFORE any code or planning
- **CONTENT:** Algorithm drafts, edge cases, data structures, pseudo-code, "what could go wrong?"
- **GOAL:** Prove understanding before solving

**Step 2: PLAN (File: `2-iteration.md`)**
- **WHEN:** After brainstorming, before coding
- **CONTENT:** Atomic, testable checklist steps
- **GOAL:** Create a map so we don't get lost

**Step 3: EXECUTE (Code + Tests)**
- **WHEN:** Only after Steps 1 & 2 are complete
- **ACTION:** TDD loop (Red â†’ Green â†’ Refactor)
- **MAINTENANCE:** Check off items in `2-iteration.md` as completed

## 2. Strict Test-Driven Development (TDD) Loop
You are prohibited from writing production code without a failing test.
1.  **Red:** Write the specific unit test. **STOP GENERATION.** Ask user to run test to confirm failure.
2.  **Green:** Write the *minimum* code to pass the test. Run test to verify.
3.  **Refactor:** Check code for clarity and maintainability.

## 3. Coding Standards (Python)
- **Language:** Python 3.11+
- **Clarity > Brevity:** Code must be debuggable and explainable. No cryptic one-liners.
- **Dependencies:** Prefer standard libraries or robust, well-known 3rd party packages. Do not reinvent the wheel.
- **Type Hints:** Use type hints for function signatures.
- **Docstrings:** Every public function must have a docstring explaining purpose, args, and return value.

## 4. Documentation Hygiene (The 3 Files)

| File | Purpose | Update When | Contains |
|------|---------|-------------|----------|
| `3-scratchpad.md` | Thinking space | **FIRST** - before any code | Algorithm drafts, edge cases, pseudo-code, design decisions |
| `2-iteration.md` | Task tracker | **CONSTANTLY** - every step | Checklist, current session state, active context |
| `1-core.md` | Project bible | **RARELY** - milestones only | Architecture, completed features, API docs |

### Rules:
- **NEVER skip the scratchpad** - even for "simple" tasks, write 2-3 lines of analysis
- **Clear `3-scratchpad.md`** immediately after feature completion
- **`1-core.md` is sacred** - only update when a phase/feature is fully complete and tested

### ðŸ”´ CRITICAL: Phase Approval
- **Only the USER can approve** marking a phase as "Done" (âœ…)
- Agent must **ask for user confirmation** before changing status from "In Progress" to "Done"
- Never auto-complete phases without explicit user approval

## 4b. Git Commit Discipline ðŸ”´ CRITICAL
**Commit frequently to create rollback points and track progress.**

### When to Commit:
1. **After TDD GREEN phase:** When tests pass for a new feature/module
2. **After REFACTOR phase:** When code is cleaned up (separate commit from feature)
3. **After bug fixes:** Each fix gets its own commit
4. **After documentation updates:** Keep docs in sync with code

### Commit Message Format (Conventional Commits):
```
<type>(<scope>): <short description>

Types: feat, fix, refactor, docs, test, chore
Scope: module name (config, parser, exporter, api_client, scraper)
```

### Examples:
- `feat(config): add ScraperConfig with validation`
- `feat(parser): add ListingParser with JSON extraction`
- `fix(exporter): handle empty listings gracefully`
- `refactor(api_client): extract URL building to method`
- `docs: update 1-core.md with Phase 2 completion`
- `test(parser): add edge case tests for missing fields`

### Workflow Integration:
```
TDD Loop:
  RED â†’ GREEN â†’ REFACTOR â†’ COMMIT â†’ next test
                              â†‘
                         Don't skip this!
```

### Tagging Milestones:
After completing a major phase, create a tag:
```bash
git tag -a v0.1.0 -m "Phase 1: Config + Models complete"
git tag -a v0.2.0 -m "Phase 2: Exporter complete"
```

## 5. Project-Specific Rules (Yad2 Scraper)
- **Target Site:** yad2.co.il (Hebrew, RTL)
- **Primary Method:** API requests to `gw.yad2.co.il/recommendations/items/realestate`
- **Fallback:** Playwright browser automation (if API is blocked)
- **Data Format:** Output ONLY Parquet files (no JSON)
- **Encoding:** Handle Hebrew text properly (UTF-8)
- **Rate Limiting:** Be respectful to the target server (add delays between requests)

## 6. Key Dependencies
```
requests            # HTTP client (primary)
playwright          # Browser automation (fallback)
pandas              # Data manipulation  
pyarrow             # Parquet file support
pytest              # Testing framework
pytest-cov          # Test coverage
responses           # Mock HTTP requests in tests
```

## 7. Project Structure (Target)
```
house_data_scrapper/
â”œâ”€â”€ scraper/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py           # Configuration management
â”‚   â”œâ”€â”€ models.py           # Listing dataclass
â”‚   â”œâ”€â”€ api_client.py       # HTTP client for Yad2 API
â”‚   â”œâ”€â”€ parser.py           # JSON parsing & data extraction
â”‚   â”œâ”€â”€ exporter.py         # Parquet export functionality
â”‚   â”œâ”€â”€ scraper.py          # Main orchestration logic
â”‚   â”œâ”€â”€ cli.py              # Command-line interface
â”‚   â””â”€â”€ browser.py          # Playwright browser (fallback)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_config.py
â”‚   â”œâ”€â”€ test_api_client.py
â”‚   â”œâ”€â”€ test_parser.py
â”‚   â”œâ”€â”€ test_exporter.py
â”‚   â””â”€â”€ test_scraper.py
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ mappings/           # JSON mapping files (city_to_neighborhoods.json, etc.)
â”‚   â””â”€â”€ output/             # Parquet files go here
â”œâ”€â”€ temp_scripts/           # Temporary scripts for short-term checks/analysis
â”œâ”€â”€ 1-core.md
â”œâ”€â”€ 2-iteration.md
â”œâ”€â”€ 3-scratchpad.md
â”œâ”€â”€ .cursorrules
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

## 8. Temporary Scripts Management ðŸ”´ CRITICAL

**All temporary scripts MUST be created in `temp_scripts/` folder.**

### Rules:
- **When creating temporary scripts:** Place ALL temporary/analysis scripts in `temp_scripts/` folder
- **Examples of temp scripts:**
  - Field analysis scripts (`analyze_api_fields.py`)
  - Data checking scripts (`check_json_redundancy.py`)
  - One-off test scripts
  - Exploration/experimentation scripts
- **When user says "cleanup":** DELETE all files in `temp_scripts/` folder
- **Purpose:** Keep project root clean, separate temporary work from production code

### Workflow:
```
Need to check/test something quickly?
  â†’ Create script in temp_scripts/
  â†’ Use it
  â†’ When user says "cleanup" â†’ DELETE temp_scripts/ contents
```

### What Goes Where:
- **`scraper/`**: Production code modules (house data scraper)
- **`tests/`**: Test files
- **`temp_scripts/`**: Temporary analysis/check scripts (deleted on cleanup)
- **Root**: Only core project files (scrapers, configs, docs)

